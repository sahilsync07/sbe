import{u as D,s as m,F as c,D as l}from"./useAdmin-DsMuefRX.js";import{C as p,x as S}from"./index-D5bctyeh.js";async function g(f,s){try{const t=await fetch(f);if(!t.ok)throw new Error("Network error");const u=await t.blob(),r=await new Promise((d,n)=>{const a=new FileReader;a.onloadend=()=>d(a.result.split(",")[1]),a.onerror=n,a.readAsDataURL(u)});return await c.writeFile({path:`image_cache/${s}.jpg`,data:r,directory:l.Data}),!0}catch(t){return console.error(`Failed to cache ${s}:`,t),!1}}async function C(){if(!p.isNativePlatform())return;const{isAdmin:f,isSuperAdmin:s}=D();if(!(!f.value&&!s.value)&&!m.isSyncing){m.isSyncing=!0;try{const u=await(await fetch("/assets/stock-data.json")).json(),r=new Map;for(const e of u)if(e.groupName!=="_META_DATA_"){for(const i of e.products)if(i.imageUrl){const w=i.productName.replace(/[^a-zA-Z0-9]/g,"_");r.set(w,i.imageUrl)}}let d=[];try{d=(await c.readdir({path:"image_cache",directory:l.Data})).files.map(i=>i.name.replace(".jpg",""))}catch{await c.mkdir({path:"image_cache",directory:l.Data,recursive:!0})}let n=0;for(const e of d)r.has(e)||(await c.deleteFile({path:`image_cache/${e}.jpg`,directory:l.Data}),n++);let a=0;const y=Array.from(r.keys()),h=5;let o=[];for(const e of y)d.includes(e)||o.push(e),o.length>=h&&(await Promise.all(o.map(i=>g(r.get(i),i))),a+=o.length,o=[]);o.length>0&&(await Promise.all(o.map(e=>g(r.get(e),e))),a+=o.length),(a>0||n>0)&&(console.log(`Delta Sync Complete: Downloaded ${a}, Deleted ${n}`),S.info(`Offline Cache Synced (+${a}, -${n})`,{autoClose:3e3,position:"bottom-center"})),m.setSyncTime(new Date().toISOString())}catch(t){console.error("Delta Sync Failed",t)}finally{m.isSyncing=!1}}}async function F(f){if(!p.isNativePlatform())return null;try{const t=`image_cache/${f.replace(/[^a-zA-Z0-9]/g,"_")}.jpg`;if(await c.stat({path:t,directory:l.Data})){const r=await c.getUri({path:t,directory:l.Data});return p.convertFileSrc(r.uri)}}catch{return null}}export{F as g,C as p};
